<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spin & Reward</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin:0;
  padding:20px;
  font-family: Arial, sans-serif;
  background:#121212;
  color:#fff;
  text-align:center;
}

#wheelContainer {
  position:relative;
  width:300px;
  height:300px;
  margin:20px auto;
}

canvas {
  border-radius:50%;
  background:#222;
}

#pointer {
  position:absolute;
  top:-10px;
  left:50%;
  transform:translateX(-50%) rotate(180deg);
  width:0;
  height:0;
  border-left:12px solid transparent;
  border-right:12px solid transparent;
  border-bottom:20px solid red;
  z-index: 10;
}

#spinBtn {
  margin-top:20px;
  padding:16px 45px;
  font-size:18px;
  font-weight:bold;
  background:#f1c40f;
  color:#000;
  border:none;
  border-radius:40px;
}

#spinBtn:disabled {
  background:#555;
  color:#aaa;
}

#withdrawBtn {
  display:block;
  margin:14px auto 0 auto;
  padding:12px 36px;
  font-size:16px;
  font-weight:bold;
  background:#22c55e;
  color:#ffffff;
  border:none;
  border-radius:40px;
  cursor:not-allowed;
}

#withdrawBtn.enabled {
  cursor:pointer;
}

.small {
  font-size:12px;
  color:#aaa;
  margin-top:6px;
}
</style>

<!-- FIREBASE (INVARIATO) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCdXbufEBn45FH-JJpRrWmbSpdY_n-DZf4",
    authDomain: "spinrewardapp-56e7f.firebaseapp.com",
    projectId: "spinrewardapp-56e7f",
    storageBucket: "spinrewardapp-56e7f.firebasestorage.app",
    messagingSenderId: "373874094522",
    appId: "1:373874094522:web:4d2b83a58d1cde08c02d83",
    measurementId: "G-Z604SL4NPK"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

</head>

<body>

<h2>ðŸŽ¯ Spin & Reward</h2>

<div><strong>Points:</strong> <span id="points">0</span></div>

<div class="small">
<strong>15,000 Points â€“ Reward</strong><br>
<strong>Gift Card</strong>
</div>

<div id="wheelContainer">
  <div id="pointer"></div>
  <canvas id="wheel" width="300" height="300"></canvas>
</div>

<button id="spinBtn">SPIN</button>
<button id="withdrawBtn" disabled>WITHDRAW</button>

<div class="small">
Rewards are promotional and subject to availability.<br>
No cash value. Not guaranteed.
</div>

<script>
alert("QUESTO Ãˆ IL FILE GIUSTO");
console.log("=== Inizio App Test WebToNative ===");
console.log("window.webToNative:", window.webToNative);
console.log("window.webToNative.admob:", window.webToNative?.admob);
// ---------------- CONFIG ----------------
const SPIN_BLOCKS = [2, 2, 1];
const COOLDOWN = 8 * 60 * 60 * 1000;
const FIXED_REWARD = 10;
const WITHDRAW_POINTS = 15000;
const WITHDRAW_FORM = "https://forms.gle/kKz8kSW8aoH7Dm7K7";

const sectors = [
  { label: "120 PT", color: "#27ae60" },
  { label: "100 PT", color: "#2ecc71" },
  { label: "50 PT",  color: "#f1c40f" },
  { label: "25 PT",  color: "#f39c12" },
  { label: "15 PT",  color: "#e67e22" },
  { label: "15 PT",  color: "#d35400" },
  { label: "10 PT",  color: "#c0392b" },
  { label: "0 PT",   color: "#7f8c8d" }
];

// ---------------- STORAGE ----------------
let points = Number(localStorage.getItem("points")) || 0;
let blockIndex = Number(localStorage.getItem("blockIndex")) || 0;
let spinsInBlock = Number(localStorage.getItem("spinsInBlock")) || 0;
let cooldownUntil = Number(localStorage.getItem("cooldownUntil")) || 0;

// ---------------- UI ----------------
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const spinBtn = document.getElementById("spinBtn");
const withdrawBtn = document.getElementById("withdrawBtn");
const pointsEl = document.getElementById("points");

pointsEl.textContent = points;

// ---------------- DRAW WHEEL ----------------
function drawWheel() {
  const r = canvas.width / 2;
  const arc = (2 * Math.PI) / sectors.length;

  sectors.forEach((s, i) => {
    const angle = i * arc;
    ctx.beginPath();
    ctx.moveTo(r, r);
    ctx.arc(r, r, r, angle, angle + arc);
    ctx.fillStyle = s.color;
    ctx.fill();

    ctx.save();
    ctx.translate(r, r);
    ctx.rotate(angle + arc / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#fff";
    ctx.font = "bold 14px Arial";
    ctx.fillText(s.label, r - 10, 5);
    ctx.restore();
  });
}
drawWheel();

// ---------------- COUNTDOWN ----------------
function updateSpinButton() {
  const now = Date.now();
  if (now < cooldownUntil) {
    const diff = cooldownUntil - now;
    const h = Math.floor(diff / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    spinBtn.disabled = true;
    spinBtn.textContent = `Next spin in ${h}h ${m}m`;
  } else {
    spinBtn.disabled = false;
    spinBtn.textContent = "SPIN";
  }
}

// ---------------- WITHDRAW ----------------
function updateWithdraw() {
  if (points >= WITHDRAW_POINTS) {
    withdrawBtn.disabled = false;
    withdrawBtn.classList.add("enabled");
  }
}

withdrawBtn.onclick = () => {
  if (!withdrawBtn.disabled) {
    window.open(WITHDRAW_FORM, "_blank");
  }
};

// ---------------- SPIN FLOW ----------------
spinBtn.onclick = () => {
  spinBtn.disabled = true;
  console.log("=== Spin cliccato ===");

  const tryShowAd = () => {
    if (window.webToNative?.admob?.rewardsAd) {
      console.log("AdMob pronto, mostro rewarded ad");

      window.webToNative.admob.rewardsAd({
        adId: "ca-app-pub-3940256099942544/5224354917", // ID demo
        rewardsAdCallback: (value) => {
          console.log("Ad callback:", value);

          try {
            const data = typeof value === "string" ? JSON.parse(value) : value;

            // gira la ruota SOLO se l'utente ha chiuso o completato l'ad
            if (
              data.status === "adDismissed" ||
              data.status === "rewardSuccess" ||
              data.status === "success"
            ) {
              onAdCompleted();
            }
          } catch (e) {
            console.log("Errore parsing callback, giro comunque");
            onAdCompleted();
          }
        }
      });
    } else {
      console.log("AdMob non pronta, riprovo tra 300ms");
      setTimeout(tryShowAd, 300); // riprova ogni 0.3 secondi
    }
  };

  tryShowAd();
};
  

  
    
    
      
      
        
        
        
      
    
  
    
    
  

  
  
    
  
    
  


window.onAdCompleted = function () {
  startSpin();
};

function startSpin() {
  const index = sectors.findIndex(s => s.label === "10 PT");
  const arc = 360 / sectors.length;

  canvas.style.transition = "none";
  canvas.style.transform = "rotate(0deg)";

  setTimeout(() => {
    const rotation = 720 + (270 - index * arc - arc / 2);
    canvas.style.transition = "transform 4s cubic-bezier(.17,.67,.12,.99)";
    canvas.style.transform = `rotate(${rotation}deg)`;
  }, 50);

  setTimeout(() => {
    points += FIXED_REWARD;
    spinsInBlock++;

    localStorage.setItem("points", points);
    localStorage.setItem("spinsInBlock", spinsInBlock);

    if (spinsInBlock >= SPIN_BLOCKS[blockIndex]) {
      spinsInBlock = 0;
      blockIndex = (blockIndex + 1) % SPIN_BLOCKS.length;
      cooldownUntil = Date.now() + COOLDOWN;

      localStorage.setItem("blockIndex", blockIndex);
      localStorage.setItem("cooldownUntil", cooldownUntil);
    }

    pointsEl.textContent = points;
    updateWithdraw();
    updateSpinButton();
  }, 4000);
}

updateWithdraw();
updateSpinButton();
</script>

</body>
</html>
